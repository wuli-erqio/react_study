## 4. 城市选择模块
### 4.1 功能分析
* 业务: 切换城市,查看该城市下的房源信息
* 功能:
1. 顶部导航栏
2. 城市列表展示 
3. 使用索引快速切换城市 
4. 点击城市名称切换城市
* 第三方组件: react-virtualizaed长列表
* 难点: 数据格式处理, react-virtualized组件在项目中的使用

### 4.2 顶部导航栏
#### 步骤
1. 打开antd-mobile组件库NavBar
2. 拷贝并正确运行
3. 调整样式和结构

### 4.3 获取并处理城市列表数据
#### 步骤
1. 页面加载时,获取数据
2. 分析数据格式
3. 转换成需要格式
4. 获取热门城市数据,并添加到现有的数据列表中(顺序)
5. 获取当前定位城市数据,并添加到数组
#### 当前定位城市数据
* 问题: 首页模块中,需要获取定位城市,城市列表模块中也需要获取定位城市,如何处理
* 答案: 封装成函数, 那个页面要获取定位城市,直接调用该方法即可
1. 在utils目录中,新建index.js,在该文件中封装
2. 创建并导出获取定位城市的函数getCurrentCity
3. 判断localStorage中是否有定位城市
4. 如果没有,就使用首页中获取定位城市的代码来获取,并存储到本地存储中,然后返回该城市数据
5. 如果有, 直接返回本地存储中的城市数据

### 4.4 长列表性能优化
#### 1. 概述
* 场景: 展示大型列表和表格数据(比如: 城市列表, 通讯录, 微博),会导致页面卡顿,滚动不流畅等性能问题
* 产生性能问题的问题: 大量DOM节点的重绘和重排
* 其他原因: 老旧设备
* 其他问题: 移动设备耗电加快, 影响移动设备电池寿命
* 优化方案: 1. 懒渲染 2.可视区域渲染
#### 2. 懒渲染说明
* 常见的长列表优化方案,常见与移动端
* 原理: 每次只渲染一部分数据(比如10条), 等渲染的数据即将滚动完时,在渲染下面部分
* 优点: 每次渲染一部分数据,速度快
* 缺点: 数据量大时, 页面中依然存在大量BOM节点,占用内存过多,降低浏览器渲染性能, 导致页面卡顿
* 使用场景: 数据量不大的情况J(比如1000条,具体还要看每条数据的复杂程度)
#### 3. 可视区域渲染(react-virtualized)
* 原理: 只渲染页面可视区域的列表,非可视区域的数据"完全不渲染", 在滚动列表时动态更新列表项
* 使用场景: 一次性展示大量数据的情况(比如: 大表格, 微博, 聊天应用等)

### 4.5 react-virtualized
#### 1.概述
* 在形目中的应用: 实现城市选择列表页面的渲染
* react-virtualized是React组件,用来高效渲染大型列表和表格数据
#### 2. 基本使用
1. 安装: npm i react-virtualized
2. 在项目入口文件index.js中导入样式文件(汁倒入一次即可)
3. 打开文档,点击List组件,进入List的文档中
4. 翻到文档底部, 将实例代码拷贝到项目中
5. 分析实例代码

### 4.6 渲染城市列表
#### 1. 让List沾满整个屏幕
1. 打开AutoSizer高阶组件的文档
2. 导入AutoSizer组件
3. 通过render-props模式, 获取到AutoSizer组件暴露的width和height属性
4. 设置list组件的width和height属性
5. 设置城市选择页面的根元素高度100%, 让list组件占满整个页面
6. 调整样式,让页面不要出现全局滚动条,避免顶部导航栏滚动
#### 2. 使用List组件渲染列表
1. 将获取到的cityList和CityIndex添加为组件的动态数据
2. 修改list组件的rowCount为cityIndex数组的长度
3. 将rowRenderer函数,添加到组件中, 以便在函数中获取到状态数据cityList和cityIndex
4. 修改list组件的rowRenderer为组件中的rowRenderer方法
5. 修改rowRenderer方法中渲染的每行结构和样式
6. 修改list组件的rowHeight为函数, 动态的计算每一行的高度(因为每一行的高度都不相同)
### 4.7 城市索引列表
#### 1. 渲染城市索引列表
1. 封装renderCityIndex方法, 用来渲染城市索引列表
2. 在方法中, 获取索引数组cityIndex, 遍历cityIndex, 渲染索引列表
3. 将索引列表改为热
4. 在state 中添加状态activeIndex 来指定当前高亮的索引
5. 在遍历cityIndex时, 添加当前字母索引是否高亮的判断条件
#### 2. 滚动城市列表让对应索引高亮
1. 给list组件添加onRowsRendered配置项, 用于获取当前列表渲染的信息
2. 通过参数startIndex获取到, 起始行索引(也就是城市列表可视区最顶部一行的索引)
3. 判断statrindex和activeIndex是否相同(判断的目的是为了提升性能,避免不必要的state更新)
4. 当startIndex和activeIndex不同时,更新状态,为startIndex的值
#### 3. 点击索引指定该索引城市
1. 给索引列表项绑定点击事件
2. 在点击事件中,通过index获取到当前项索引号
3. 调用List组件的scrollToRow方法,让List组件滚动到指定行
* 在constructor中, 调用React.createRef() 创建ref对象
* 将创建好的ref对象,添加到list组件的ref上
* 通过ref  的curren属性,获取组件实例, 在调用组件的scrollToRow方法
4. 设置list组件的scrollToAlignment方法,让list组件滚动到指定行
5. 对于点击索引无法正确定位的问题,调用List组件measureAllRows方法,提前计算高度来解决
### 4.8 切换城市
1. 给城市列表顶绑定点击事件
2. 判断当前城市是否有房源信息(只有北上广深有数据)
3. 如果有房源数据, 则保存当前城市数据到本地缓存中,并返回上一页
4. 如果没有信息,提示无房源